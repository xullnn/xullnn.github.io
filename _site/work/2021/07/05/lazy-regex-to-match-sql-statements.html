<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lazy regular expression to match SQL statements</title>
<!-- The styles.css referenced here is generated by Jekyll from the styles.scss -->
    <link rel="stylesheet" href="/assets/css/styles.css">
  </head>
  <body>
      <div class="post">

  <!-- <nav>
  
    <a href="/" >
      Home
    </a>
  
    <a href="/blog.html" >
      Blog
    </a>
  
    <a href="photography.html" >
      Photography
    </a>
  
    <a href="/me.html" >
      Me
    </a>
  
</nav> -->


<!-- <div class="bar_nav">
  <p>Home</p>
  <p>Portfolio</p>
  <p>Blog</p>
  <p>Me</p>
</div> -->


<div class="bar_nav">
  
    
    <p ><a href="/">Home</a></p>
  
    
    <p  class="current" ><a href="/blog.html">Blog</a></p>
  
    
    <p ><a href="photography.html">Photography</a></p>
  
    
    <p ><a href="/me.html">Me</a></p>
  
</div>

  <h1>Lazy regular expression to match SQL statements</h1>
  <p>05 Jul 2021</p>


  <p>In my recent work I had to extract regex statements from a <code>.sql</code> file, and get an array of strings. And I need a refresh on regular expression. A simplified example file may look like this <code>schema.sql</code>:</p>

<div class="language-SQL highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#B06;font-weight:bold">CREATE</span> <span style="color:#339;font-weight:bold">TABLE</span> users (
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  id serial <span style="color:#088;font-weight:bold">PRIMARY</span> <span style="color:#339;font-weight:bold">KEY</span>,
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  nickname <span style="color:#0a8;font-weight:bold">varchar</span>(<span style="color:#00D">100</span>) <span style="color:#080;font-weight:bold">CHECK</span>(length(nickname) &gt; <span style="color:#00D">2</span>) <span style="color:#088;font-weight:bold">UNIQUE</span> <span style="color:#080;font-weight:bold">NOT</span> <span style="color:#069">NULL</span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>);
<span class="line-numbers"> <strong><a href="#n5" name="n5">5</a></strong></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span><span style="color:#777">-- This table holds food items such as egg, pork, fried potato, multiple food items</span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#B06;font-weight:bold">CREATE</span> <span style="color:#339;font-weight:bold">TABLE</span> food_items (
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  id serial <span style="color:#088;font-weight:bold">PRIMARY</span> <span style="color:#339;font-weight:bold">KEY</span>,
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  name <span style="color:#0a8;font-weight:bold">text</span> <span style="color:#080;font-weight:bold">NOT</span> <span style="color:#069">NULL</span> <span style="color:#088;font-weight:bold">UNIQUE</span> <span style="color:#080;font-weight:bold">CHECK</span> (length(name) &gt; <span style="color:#00D">2</span>),
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>  amount <span style="color:#0a8;font-weight:bold">integer</span> <span style="color:#080;font-weight:bold">NOT</span> <span style="color:#069">NULL</span> <span style="color:#080;font-weight:bold">CHECK</span> (amount &gt; <span style="color:#00D">0</span>)
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>);
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span><span style="color:#777">-- more statements omitted</span>
</pre></div>
</div>
</div>

<h2 id="match-things-from-create-to-semicolon-">Match things from <code>CREATE</code> to semicolon <code>;</code></h2>

<p>If there’s only one SQL statement, things would be easy: <code>/CREATE(.|\n)+;/</code> or <code>/CREATE[\s\S]+;/</code> can work. But now there’re more than one(assuming we don’t user <code>;</code> in comments). So very likely we need the <code>g</code> flag to perform a global match on every single statement.</p>

<p>And the two regexes mentioned above won’t stop till the last <code>;</code> in the string. Then the two statements are merged into one, with the comments mixed in.</p>

<h2 id="as-many-as-vs-as-soon-as">As many as vs. As soon as</h2>

<p><strong>Greedy</strong></p>

<p>With the <code>+</code> quantifier, the default match style of regex is the ‘greedy’ mode. The regex will try to consume as many characters as it can to find the final match. For example <code>/CREATE(.|\n)+;/</code> will match things from the first <code>CREATE</code> then traverse any chars including <code>;</code>, note that <code>(.|\n)</code> doesn’t exclude <code>;</code>, till it hits <em>the end of the string.</em>. Because if you don’t go through all the chars, you won’t know if you miss any <code>;</code> in the middle. After hitting the end of the string the regex will backtrace the string to find the last <code>;</code> in the string. Then the matching complete, it has matched as many chars as it can by the giving rule. That’s “greedy”.</p>

<p>We can try in <code>Node.js</code> with the <code>fs</code> module:</p>

<div class="language-js highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>const fs = require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">fs</span><span style="color:#710">'</span></span>);
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>fs.readFile(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">./db/schema.sql</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">utf8</span><span style="color:#710">'</span></span>, (err, data) =&gt; {
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  console.log(data.match(<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">CREATE(.|</span><span style="color:#D20">\n</span><span style="color:#808">)+;</span><span style="color:#404">/</span><span style="color:#C2C">g</span></span>));
<span class="line-numbers"><strong><a href="#n5" name="n5">5</a></strong></span>  <span style="color:#777">// we can also use [\s\S]+ instead of (.|\n)+</span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>});
</pre></div>
</div>
</div>

<p><strong>Lazy</strong></p>

<p>The opposite of greedy is lazy. And to make the previously greedy regex lazy, we need another quantifier <code>?</code>. The <code>?</code> means ‘zero or more’ if it is used alone, for example <code>/a?/</code> means zero or more <code>'a'</code>. And the match result of <code>'cba'.match(/a?/)</code> would be an mepty string <code>''</code> because ‘zero or more’ means zero(no match) is ok too.</p>

<p>But when combining with <code>+</code> quantifier, the meaning changes. In our SQL case, adding <code>?</code> right after <code>+</code> will convert the match mode to be ‘lazy’ – <code>/CREATE(.|\n)+?;/g</code>. This simple change let the regex stop on first <code>;</code> it meets, then it counts a match. With the user of the global match flag <code>g</code>, the next matching starts after the first <code>;</code>. We can say that the regex is satisfied as soon as it hit the first <code>;</code> because it’s ‘lazy’.</p>

<h2 id="neither-greedy-nor-lazy">Neither greedy nor lazy</h2>

<p>It’s a bit tricky to figure things out when thinking about ‘greedy’ and ‘lazy’. However, we have alternatives. I mentioned that <code>(.|\n)</code> or <code>[\s\S]+</code> doesn’t exclude <code>;</code>, so in greedy mode the regex keeps going when it meets <code>;</code> before it hits the end of the string.</p>

<p>By simply exclude <code>;</code> in the middle, we get rid of the consideration of greedy or lazy mode. How about <code>/CREATE[^;]+;/g</code>. Though technically we are in greedy mode but we may not have noticed it if I don’t mention this. Here <code>[^;]+</code> means “one or more non-semicolon chars”, in other words, this matches all chars except for <code>;</code>. This ‘shrinks’ the searching logic to the nearest semicolon. And it works just like a lazy one in the mode of greedy.</p>

<h2 id="summary">Summary</h2>

<p>Playing with regex can be both frustrating and interesting. But you’ll find the simple logic of <code>true</code> or <code>false</code>, <code>include</code> or <code>exclude</code> can generate so many different solutions to the same task. It’s fun!</p>


</div>

  </body>
</html>